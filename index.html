<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Слогострой - Русская Азбука</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for loading external audio files and simple game sounds -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Custom CSS for the letter blocks */
        .letter-block {
            cursor: grab;
            user-select: none;
            touch-action: none; /* Prevents default touch scrolling */
            transition: transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-family: 'Inter', sans-serif;
            font-weight: 800;
        }
        /* Style for the empty slots */
        .slot-active {
            border: 4px dashed #60a5fa; /* Blue-400 */
        }
        /* Style for the feedback messages */
        .feedback-message {
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: scale(0.8);
        }
        .feedback-visible {
            opacity: 1;
            transform: scale(1);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- Main Game Container -->
    <div id="game-container" class="w-full max-w-xl bg-white rounded-3xl shadow-2xl p-6 md:p-10 border-4 border-indigo-200">
        <h1 class="text-4xl font-extrabold text-indigo-700 text-center mb-6">Слогострой</h1>
        <p class="text-center text-gray-600 mb-8">Собери слово, перетаскивая буквы в пустые места!</p>

        <!-- Word Display Area (Slots) -->
        <div id="word-slots" class="flex justify-center gap-2 md:gap-4 h-24 mb-10">
            <!-- Slots will be inserted here by JS -->
        </div>

        <!-- Feedback Message -->
        <div id="feedback" class="feedback-message text-center h-10 mb-8">
            <span id="feedback-text" class="text-3xl font-bold text-green-600">Отлично!</span>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center py-10">
             <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mb-3"></div>
             <p class="text-indigo-500 font-medium">Загрузка аудио...</p>
        </div>

        <!-- Letter Selection Area (Draggable Blocks) -->
        <div id="letter-selection" class="flex justify-center flex-wrap gap-3 p-4 bg-indigo-100 rounded-xl shadow-inner min-h-[120px] hidden">
            <!-- Letter blocks will be inserted here by JS -->
        </div>

        <!-- Control/Info Area -->
        <div class="mt-8 text-center">
            <button id="next-word-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 opacity-0 pointer-events-none" disabled>
                Следующее слово
            </button>
            <p id="word-info" class="mt-4 text-sm text-gray-500"></p>
        </div>
    </div>

    <script type="module">
        // --- Game Data ---
        const wordData = [
            { target: "КОТ", translation: "Cat" },
            { target: "ДОМ", translation: "House" },
            { target: "МАМА", translation: "Mom" },
            { target: "СОК", translation: "Juice" },
            { target: "РЫБА", translation: "Fish" },
            { target: "КУБИК", translation: "Cube" },
            { target: "СЛОН", translation: "Elephant" },
            { target: "ТРАВА", translation: "Grass" },
        ];

        // --- Game State & Elements ---
        let currentWordIndex = 0;
        let activeDraggable = null;
        let originalPosition = { x: 0, y: 0 };
        let currentWordSlots = [];
        let isDragging = false;
        let isGameLocked = false;
        let isAudioReady = false;

        const wordSlotsEl = document.getElementById('word-slots');
        const letterSelectionEl = document.getElementById('letter-selection');
        const feedbackEl = document.getElementById('feedback');
        const feedbackTextEl = document.getElementById('feedback-text');
        const nextWordButton = document.getElementById('next-word-button');
        const wordInfoEl = document.getElementById('word-info');
        const loadingIndicatorEl = document.getElementById('loading-indicator');

        // --- Audio Setup (Tone.js & MP3 Loading) ---
        
        // !!! МЕСТО, КУДА НУЖНО ВСТАВИТЬ ВАШИ АУДИОФАЙЛЫ !!!
        // Замените значения (URL) на пути к вашим MP3-файлам.
        // Используйте абсолютные URL (начиная с http:// или https://) или относительные пути.
        const LETTER_AUDIO_SOURCES = {
            'А': 'your_folder/A.mp3', // <-- ЗАМЕНИТЬ
            'Б': 'your_folder/B.mp3', // <-- ЗАМЕНИТЬ
            'В': 'your_folder/V.mp3', // <-- ЗАМЕНИТЬ
            'Г': 'your_folder/G.mp3', // <-- ЗАМЕНИТЬ
            'Д': 'your_folder/D.mp3', // <-- ЗАМЕНИТЬ
            'Е': 'your_folder/Ye.mp3', // <-- ЗАМЕНИТЬ
            'И': 'your_folder/I.mp3', // <-- ЗАМЕНИТЬ
            'К': 'your_folder/K.mp3', // <-- ЗАМЕНИТЬ
            'Л': 'your_folder/L.mp3', // <-- ЗАМЕНИТЬ
            'М': 'your_folder/M.mp3', // <-- ЗАМЕНИТЬ
            'Н': 'your_folder/N.mp3', // <-- ЗАМЕНИТЬ
            'О': 'your_folder/O.mp3', // <-- ЗАМЕНИТЬ
            'Р': 'your_folder/R.mp3', // <-- ЗАМЕНИТЬ
            'С': 'your_folder/S.mp3', // <-- ЗАМЕНИТЬ
            'Т': 'your_folder/T.mp3', // <-- ЗАМЕНИТЬ
            'У': 'your_folder/U.mp3', // <-- ЗАМЕНИТЬ
            'Ы': 'your_folder/Y.mp3', // <-- ЗАМЕНИТЬ
            // Добавьте сюда другие буквы, которые вы используете!
        };

        // Объект для хранения загруженных аудио плееров Tone.js
        const letterPlayers = {};

        // Синтезатор для простых звуков успеха/ошибки
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: {
                attack: 0.005,
                decay: 0.1,
                sustain: 0.05,
                release: 0.1,
            }
        }).toDestination();
        
        // Асинхронная функция загрузки всех аудиофайлов
        async function loadAudioFiles() {
            const lettersToLoad = Object.keys(LETTER_AUDIO_SOURCES);
            const loadPromises = [];

            for (const letter of lettersToLoad) {
                const url = LETTER_AUDIO_SOURCES[letter];
                
                if (url && !url.includes('your_folder')) {
                    const player = new Tone.Player(url).toDestination();
                    letterPlayers[letter] = player;
                    loadPromises.push(new Promise(resolve => {
                        // Ожидаем события загрузки
                        player.onload = resolve;
                        // Добавляем таймаут на случай ошибки загрузки, чтобы не заблокировать игру
                        setTimeout(resolve, 5000); 
                    }));
                } else {
                    // Если URL не заменен, просто игнорируем его и разрешаем промис
                    console.warn(`[Аудио]: URL для буквы '${letter}' не указан или является placeholder-ом. Звук не будет воспроизведен.`);
                    loadPromises.push(Promise.resolve());
                }
            }

            try {
                // Ждем загрузки всех файлов
                await Promise.all(loadPromises);
                isAudioReady = true;
                console.log("[Аудио]: Все необходимые аудиофайлы загружены.");
            } catch (error) {
                console.error("[Аудио]: Ошибка при загрузке аудиофайлов. Игра запустится без звуков букв.", error);
            }
        }

        // Обновленная функция воспроизведения звука
        const playLetterSound = (letter) => {
            if (!isAudioReady) return;
            if (Tone.context.state !== 'running') { Tone.start(); }
            const player = letterPlayers[letter];
            if (player && player.state === 'loaded') {
                // Останавливаем, если уже играет, и начинаем сначала
                player.stop(); 
                player.start();
            }
        };

        const playSuccess = () => {
            if (Tone.context.state !== 'running') { Tone.start(); }
            synth.triggerAttackRelease("C5", "8n", Tone.now());
            synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.1);
            synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
        };

        const playError = () => {
            if (Tone.context.state !== 'running') { Tone.start(); }
            synth.triggerAttackRelease("C4", "16n", Tone.now());
            synth.triggerAttackRelease("B3", "16n", Tone.now() + 0.1);
        };

        // --- Utility Functions ---

        /**
         * Shuffles an array in place.
         * @param {Array} a items The array containing the items.
         */
        function shuffleArray(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // --- Drag and Drop Logic ---

        function getEventPoint(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function startDrag(e) {
            if (isGameLocked || !isAudioReady) return;
            const block = e.currentTarget;
            if (block.classList.contains('placed')) return; // Already correctly placed

            isDragging = true;
            activeDraggable = block;
            block.style.zIndex = 1000;
            block.classList.add('shadow-xl', 'ring-4', 'ring-indigo-400');
            
            // Воспроизведение звука буквы (теперь MP3)
            const letter = block.dataset.letter;
            playLetterSound(letter);

            // Get original position before dragging starts
            const rect = block.getBoundingClientRect();
            originalPosition.x = rect.left;
            originalPosition.y = rect.top;

            // Prevent default touch/mouse behavior on start
            e.preventDefault(); 
        }

        function moveDrag(e) {
            if (!activeDraggable || !isDragging) return;
            e.preventDefault(); // Crucial for smooth mobile dragging

            const point = getEventPoint(e);
            
            // Calculate new position relative to the viewport
            const rect = activeDraggable.getBoundingClientRect();
            const dx = point.x - (rect.left + rect.width / 2);
            const dy = point.y - (rect.top + rect.height / 2);

            // Apply transform for movement
            activeDraggable.style.transform = `translate(${dx}px, ${dy}px)`;
        }

        function endDrag(e) {
            if (!activeDraggable || !isDragging) return;
            isDragging = false;
            
            activeDraggable.style.zIndex = 10;
            activeDraggable.classList.remove('shadow-xl', 'ring-4', 'ring-indigo-400');

            // Check collision with word slots
            const currentRect = activeDraggable.getBoundingClientRect();
            let placed = false;

            currentWordSlots.forEach(slot => {
                const slotRect = slot.element.getBoundingClientRect();
                
                // Simple overlap check
                const overlap = (
                    currentRect.left < slotRect.right &&
                    currentRect.right > slotRect.left &&
                    currentRect.top < slotRect.bottom &&
                    currentRect.bottom > slotRect.top
                );

                if (overlap && !slot.filled) {
                    // Check if the letter is correct for the slot
                    if (activeDraggable.dataset.letter === slot.correctLetter) {
                        // Correct placement
                        slot.filled = true;
                        slot.element.classList.remove('slot-active', 'bg-white');
                        slot.element.classList.add('bg-indigo-300', 'text-indigo-800', 'border-indigo-400');
                        activeDraggable.classList.add('placed');
                        activeDraggable.style.transform = 'none'; // Snap to original letter's position
                        activeDraggable.style.position = 'absolute'; // Temporarily take out of flow for smooth transition
                        
                        // Center the letter inside the slot visually
                        const finalX = slotRect.left + (slotRect.width / 2) - (currentRect.width / 2);
                        const finalY = slotRect.top + (slotRect.height / 2) - (currentRect.height / 2);

                        activeDraggable.style.left = `${finalX}px`;
                        activeDraggable.style.top = `${finalY}px`;
                        
                        // Удаляем силуэт и вставляем перетаскиваемый блок в слот
                        slot.element.innerHTML = ''; 
                        slot.element.appendChild(activeDraggable);
                        
                        // Reset the draggable element's styles to snap it in place inside the slot
                        activeDraggable.style.position = 'static';
                        activeDraggable.style.transform = 'none';
                        activeDraggable.classList.remove('letter-block'); // Remove drag behavior

                        playSuccess();
                        placed = true;
                        
                        checkWinCondition();
                    } else {
                        // Incorrect placement
                        playError();
                        // Snap back to original position
                        activeDraggable.style.transform = 'none';
                    }
                }
            });

            if (!placed) {
                // If not placed correctly, snap back to original position (handled by CSS transition: none)
                activeDraggable.style.transform = 'none';
            }
            
            activeDraggable = null;
        }

        // --- Game Flow Functions ---

        function checkWinCondition() {
            const allFilled = currentWordSlots.every(slot => slot.filled);
            
            if (allFilled) {
                isGameLocked = true;
                showFeedback("ВЕРНО!", "text-green-600");
                nextWordButton.classList.remove('opacity-0', 'pointer-events-none');
                nextWordButton.disabled = false;
                
                // Show the translation (info is stored in the first slot's data)
                const info = currentWordSlots[0].translation;
                wordInfoEl.textContent = `(${info})`;

                // Final celebration sound
                setTimeout(playSuccess, 500);
            }
        }

        function showFeedback(text, colorClass) {
            feedbackTextEl.textContent = text;
            feedbackTextEl.className = colorClass + " text-3xl font-bold";
            feedbackEl.classList.add('feedback-visible');
            
            setTimeout(() => {
                feedbackEl.classList.remove('feedback-visible');
            }, 1500);
        }

        function loadWord(index) {
            if (index >= wordData.length) {
                showFeedback("Игра окончена! Молодец!", "text-blue-600");
                nextWordButton.textContent = "Начать сначала";
                currentWordIndex = 0; // Loop back for replay
                return;
            }

            isGameLocked = false;
            wordSlotsEl.innerHTML = '';
            letterSelectionEl.innerHTML = '';
            currentWordSlots = [];
            wordInfoEl.textContent = '';
            nextWordButton.classList.add('opacity-0', 'pointer-events-none');
            nextWordButton.disabled = true;

            const word = wordData[index];
            const targetWord = word.target.split('');
            const scrambledLetters = shuffleArray([...targetWord]); // Get and scramble letters

            // 1. Create Slots
            targetWord.forEach((letter, idx) => {
                const slot = document.createElement('div');
                slot.className = 'w-16 h-20 md:w-20 md:h-24 flex items-center justify-center border-4 border-dashed border-gray-300 rounded-lg slot-active bg-white text-3xl md:text-5xl font-extrabold transition duration-300';
                slot.dataset.index = idx;
                slot.dataset.correct = letter;
                
                // Добавление силуэта (подсказки) в ячейку
                slot.innerHTML = `<span class="text-gray-400 opacity-30">${letter}</span>`;
                
                // Store slot data
                const slotData = {
                    element: slot,
                    correctLetter: letter,
                    filled: false,
                    translation: word.translation
                };
                currentWordSlots.push(slotData);

                wordSlotsEl.appendChild(slot);
            });

            // 2. Create Draggable Letter Blocks
            scrambledLetters.forEach(letter => {
                const block = document.createElement('div');
                block.className = 'letter-block w-14 h-14 md:w-16 md:h-16 flex items-center justify-center bg-indigo-500 text-white text-3xl md:text-4xl rounded-xl transition duration-300 hover:bg-indigo-600';
                block.textContent = letter;
                block.dataset.letter = letter;

                // Add drag listeners
                block.addEventListener('mousedown', startDrag);
                block.addEventListener('touchstart', startDrag);
                
                letterSelectionEl.appendChild(block);
            });
        }

        function nextWord() {
            currentWordIndex++;
            loadWord(currentWordIndex);
        }

        // --- Event Listeners and Initialization ---

        async function init() {
            // Сначала загружаем аудио
            await loadAudioFiles();
            
            // Скрываем индикатор загрузки и показываем поле для выбора букв
            loadingIndicatorEl.classList.add('hidden');
            letterSelectionEl.classList.remove('hidden');

            // Global listeners for movement and release
            document.addEventListener('mousemove', moveDrag);
            document.addEventListener('touchmove', moveDrag, { passive: false });

            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            nextWordButton.addEventListener('click', nextWord);

            // Start the game
            shuffleArray(wordData); // Randomize word order
            loadWord(currentWordIndex);
        }

        // Wait for the window to load before initializing the game
        window.onload = init;

    </script>
</body>
</html>

